---
title: "20251216_周二_交换机淘汰断网doris可能发生的风险"
date: "2025-12-16"
category: "日报"
tags: "日报"
img: ""
priority: "0.7"
changefreq: "weekly"
---
背景：[DEPARTMENT]核心交换机，汰换断网1-2min，评估当前Doris集群如果热机断网会不会有什么风险及脑裂风险。

# 关于 Doris 集群核心交换机汰换风险评估的简要结论

根据核心交换机汰换计划（预计断网 1-2 分钟），我们对当前的 Doris 集群（3 FE Follower/Master + 1 FE Observer）的服务稳定性及潜在脑裂风险进行了评估。

---

### 一、核心评估结论 (FE 稳定性)


| 评估项            | 结论           | 说明                                                                                                                                              |
| :---------------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------ |
| **双主/脑裂风险** | **极低**       | Doris FE 使用 Raft 多数派机制（需 3 个 Master/Follower 中的 2 个相互通信）。网络中断时，无法形成多数派，Master 会自动降级，**不会出现双主现象**。 |
| **服务影响**      | **服务中断**   | 在 1-2 分钟断网期间，由于无法选举或维持 Master，FE 集群将处于**无主状态**，**所有元数据写入操作（Load、Schema 变更）及查询将失败**。              |
| **恢复时长预估**  | **3 - 5 分钟** | 网络恢复后，FE 需重新选举 Master（通常 10-30 秒）。为保险起见，建议预留**5 分钟**的**服务不可用**时间窗口。                                       |

---

### 二、应对措施及建议

为保障数据一致性和平稳过渡，建议采取以下措施：

1. **停服通知：** 提前向所有业务方发送正式通知，说明本次操作将导致 **5 分钟**的服务不可用，请业务方做好准备。
2. **停止写入：** 在交换机切换前，**手动暂停所有正在运行的 Load 任务**（尤其是 Routine Load），避免因网络中断导致数据状态不确定。
3. **恢复步骤：** 切换完成后，首要任务是确认 FE Master 成功选出，随后逐步恢复暂停的 Load 任务。

---

### 三、需决策的关键问题

1. **服务停用时间窗口：** **业务方是否已接受 5 分钟的服务不可用时间**作为本次操作的保障时间？
2. **写入任务控制：** 是否同意在切换前**暂停所有 Doris 集群的 Load 写入任务**？

# 附录-详细分析

## Doris 集群核心交换机汰换断网风险评估与建议

评估核心交换机汰换导致的 **1-2 分钟**断网对当前 Doris 集群的风险，特别是脑裂（Split-Brain）风险。


| 节点名              | IP 地址       | 说明                            |
| :------------------ | :------------ | :------------------------------ |
| `[HOSTNAME]` | [IP_ADDRESS] | **Doris FE Master**，Doris BE   |
| `[HOSTNAME]` | [IP_ADDRESS] | **Doris FE Follower**，Doris BE |
| `[HOSTNAME]` | [IP_ADDRESS] | **Doris FE Follower**，Doris BE |
| `[HOSTNAME]` | [IP_ADDRESS] | **Doris FE Observer**，Doris BE |

---

### 1. 脑裂风险评估（FE 节点）

Doris 的 **FE（Frontend）节点**使用 **Raft 协议**进行集群化部署和高可用选举，以确保元数据（Metadata）的一致性和高可用性。

**核心结论：**
在 **1-2 分钟**的断网时间内，Doris FE 集群发生**双主（脑裂）的概率极低，但集群会对外停止服务。**

#### **Raft 协议与双主/脑裂**

* **Raft 协议机制：** Raft 协议要求集群中**大多数（Majority）节点**同意才能选出一个 Leader（即 Doris FE Master）。
  * FE 集群：3 个 Follower/Master 节点 + 1 个 Observer 节点 = **4 个 FE 节点**。
  * **Follower/Master 节点**（即：`[HOSTNAME]`、`[HOSTNAME]`、`[HOSTNAME]`）是参与 Raft 选举和写操作的节点，它们构成多数派机制的基础。
  * **多数派要求：** 参与选举的 3 个节点中，**必须有 2 个节点**能相互通信，才能选出 Master 或维持 Master 状态。
* **断网影响：** 当核心交换机断网 1-2 分钟，**所有 FE 节点**都将**无法相互通信**。
  * 由于无法形成多数派（**2 个**节点相互通信），**现有的 Master 会认为自己已经与多数派失联，将自动降级为 Follower**。
  * 同时，集群也**无法选出新的 Master**。
* **双主概率：** 由于 Master 降级并无法选出新的 Master，**集群在断网期间不会出现两个或多个 Master**，即**双主/脑裂风险极低**。

#### **集群故障转移机制动作**

1. **FE Master 降级：** 现任 Master (`[HOSTNAME]`) 发现无法与多数派 Follower 通信，将**自动降级**为 Follower。
2. **选举失败：** 剩余节点（包括原 Master）尝试发起 Leader 选举，但由于网络中断，**所有节点都无法收到多数派的投票**，选举超时，无法选出新的 Master。
3. **服务停止：** 在断网期间，**FE 集群处于无主状态**，**所有元数据写入操作（如 Schema 变更、Load 任务提交、Routine Load）将失败**。由于查询需要 Master 协调，**绝大多数查询也会失败或超时**。

> **Observer 节点：** `[HOSTNAME]` 是 Observer，它不参与 Raft 选举和写多数派的投票，仅同步元数据并对外提供读服务。断网期间它同样无法与 Master 通信，无法同步最新元数据。

---

### 2. BE 节点风险评估

BE（Backend）节点存储数据分片，彼此间需要通信以进行数据同步（Compaction、Tablet 均衡等）。它们通过 Master FE 获取元数据。

* **断网影响：** 1-2 分钟断网期间，BE 节点之间无法通信，也无法与 FE 节点通信。
* **脑裂风险：** BE 节点之间**没有**高可用选举机制，它们接收 FE Master 的指令。因此，BE 节点**不存在**脑裂或双主问题。
* **数据读写：**
  * **查询：** 由于 FE Master 停服，**所有查询都会中断/失败**。
  * **写入（Load）：** Load 任务需要 FE Master 协调，FE 停服导致 Load **失败/暂停**。
  * **数据一致性：** 短暂断网不会导致 BE 数据丢失或不一致。网络恢复后，BE 会重新连接 FE Master（一旦选出）并恢复所有正常的数据同步和 Compaction 流程。

---

### 3. 建议采取的措施


| 阶段                                                                                                                             | 措施                    | 目的                                                                                                                                   |
| :------------------------------------------------------------------------------------------------------------------------------- | :---------------------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| **准备阶段**                                                                                                                     | **1. 业务通知**         | **最关键的一步。** 提前通知所有依赖该 Doris 集群的业务方，说明计划停服时间窗口（**预计停服 5 分钟**，留足 Buffer），避免影响关键业务。 |
|                                                                                                                                  | **2. 停止写入任务**     | **在交换机切换前，暂停所有 Load 任务（尤其 Routine Load）**。避免断网期间 Load 失败、重试或处于不确定状态。                            |
|                                                                                                                                  | **3. 状态检查**         | 切换前检查集群状态：`SHOW PROC '/frontends'` 确认 Master 健康；`SHOW PROC '/backends'` 确认所有 BE 健康。                              |
| **执行阶段**                                                                                                                     | **4. 核心交换机汰换**   | 执行汰换操作，网络中断**1-2 分钟**。                                                                                                   |
| **恢复阶段**                                                                                                                     | **5. 观察 Master 选举** | 网络恢复后，FE 节点会**自动开始新的 Raft Leader 选举**。                                                                               |
| * Master 选举时间通常**在几秒到几十秒内**完成。                                                                                  |                         |                                                                                                                                        |
| ***确认：** 检查 FE 日志或使用 `mysql -hFE_IP -P9030` 连接任一 FE 节点，执行 `SHOW PROC '/frontends'` 确认 Master 已被成功选出。 |                         |                                                                                                                                        |
|                                                                                                                                  | **6. 恢复写入任务**     | 确认 Master 选举完成、集群状态正常后，**逐步恢复**所有暂停的 Load 任务。                                                               |
|                                                                                                                                  | **7. 业务验证**         | 通知业务方进行读写查询验证。                                                                                                           |

---

### 4. 需要讨论的关键问题

汇报时，应强调风险点和控制措施，聚焦在**服务影响时间**。

1. **停服时间窗口确认**

   * **问题：** **业务方是否已接受** **5 分钟**（1-2 分钟中断 + 3 分钟 Buffer）的**停服**时间窗口？
   * **说明：** 尽管网络中断只有 1-2 分钟，但 Doris FE **选举 Master 需要时间**（通常 10s-30s），服务完全恢复需要更多时间。为安全起见，应按 5 分钟的**服务不可用**时间进行规划。
2. **风险控制措施**

   * **问题：** 是否同意在交换机切换前**暂停**所有集群写入（Load）任务？
   * **说明：** 这是避免数据写入状态不确定的最稳妥措施。
3. **回滚/失败预案**

   * **问题：** 如果核心交换机切换后**网络没有在预期内恢复**，或者 Doris 集群**长时间无法选出 Master**，是否有明确的回滚或降级预案？
   * **说明：** 确保有清晰的步骤来处理网络恢复失败或集群自愈失败的极端情况。

---

**总结：** 核心交换机汰换导致的 1-2 分钟断网，**不会**引发 Doris FE 的脑裂（双主）风险。**主要风险是集群在断网期间将停止所有读写服务，服务恢复时间约为 3-5 分钟。**
